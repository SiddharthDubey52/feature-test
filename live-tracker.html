<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Live Location Tracker</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .tracking-panel {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            color: #333;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        .status-active { background-color: #28a745; }
        .status-inactive { background-color: #dc3545; }
        .status-waiting { background-color: #ffc107; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .location-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .location-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #007bff;
        }
        .location-card h3 {
            margin-top: 0;
            color: #007bff;
        }
        .data-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .data-label {
            font-weight: bold;
            color: #495057;
        }
        .data-value {
            font-family: 'Courier New', monospace;
            color: #007bff;
        }
        .coordinates {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }
        .coordinates-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #28a745;
            font-family: 'Courier New', monospace;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 0 10px;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        .tracking-log {
            background: rgba(0,0,0,0.8);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .log-info { background: rgba(23, 162, 184, 0.2); }
        .log-success { background: rgba(40, 167, 69, 0.2); }
        .log-warning { background: rgba(255, 193, 7, 0.2); }
        .log-error { background: rgba(220, 53, 69, 0.2); }
        .accuracy-meter {
            background: #e9ecef;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 10px 0;
        }
        .accuracy-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #ffc107, #dc3545);
            transition: width 0.3s ease;
        }
        .map-placeholder {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Live Location Tracker</h1>
            <p>Real-time user tracking with multiple location sources</p>
        </div>

        <div class="tracking-panel">
            <h3>
                <span id="status-indicator" class="status-indicator status-inactive"></span>
                Tracking Status: <span id="tracking-status">Inactive</span>
            </h3>
            
            <div class="controls">
                <button class="btn btn-success" onclick="startLiveTracking()">üöÄ Start Live Tracking</button>
                <button class="btn btn-danger" onclick="stopLiveTracking()">‚èπÔ∏è Stop Tracking</button>
                <button class="btn" onclick="trackOnce()">üìç Track Once</button>
                <button class="btn" onclick="exportData()">üíæ Export Data</button>
            </div>

            <div class="data-item">
                <span class="data-label">Tracking Interval:</span>
                <span class="data-value">
                    <select id="interval-select" onchange="updateInterval()">
                        <option value="5000">5 seconds</option>
                        <option value="10000" selected>10 seconds</option>
                        <option value="30000">30 seconds</option>
                        <option value="60000">1 minute</option>
                        <option value="300000">5 minutes</option>
                    </select>
                </span>
            </div>

            <div class="data-item">
                <span class="data-label">Total Tracking Points:</span>
                <span class="data-value" id="tracking-count">0</span>
            </div>

            <div class="data-item">
                <span class="data-label">Session Duration:</span>
                <span class="data-value" id="session-duration">00:00:00</span>
            </div>
        </div>

        <div class="location-grid" id="location-grid">
            <!-- Location cards will be populated here -->
        </div>

        <div class="tracking-panel">
            <h3>üó∫Ô∏è Location Visualization</h3>
            <div class="map-placeholder">
                üìç Location map would appear here<br>
                <small>(Google Maps API integration available)</small>
            </div>
        </div>

        <div class="tracking-log" id="tracking-log">
            <div class="log-entry log-info">üîç Live tracking system initialized</div>
            <div class="log-entry log-info">üì° Ready to track user location in real-time</div>
        </div>
    </div>

    <script>
        let trackingInterval = null;
        let trackingStartTime = null;
        let trackingCount = 0;
        let sessionDurationInterval = null;
        let trackingData = [];

        // Enhanced geolocation options for maximum accuracy
        const geoOptions = {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0 // Always get fresh location
        };

        function addLogEntry(message, type = 'info') {
            const log = document.getElementById('tracking-log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span style="color: #adb5bd;">[${timestamp}]</span> ${message}`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function updateStatus(status, className) {
            document.getElementById('tracking-status').textContent = status;
            const indicator = document.getElementById('status-indicator');
            indicator.className = `status-indicator ${className}`;
        }

        function updateSessionDuration() {
            if (trackingStartTime) {
                const duration = Math.floor((Date.now() - trackingStartTime) / 1000);
                const hours = Math.floor(duration / 3600).toString().padStart(2, '0');
                const minutes = Math.floor((duration % 3600) / 60).toString().padStart(2, '0');
                const seconds = (duration % 60).toString().padStart(2, '0');
                document.getElementById('session-duration').textContent = `${hours}:${minutes}:${seconds}`;
            }
        }

        async function getCurrentLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation is not supported'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    position => resolve(position),
                    error => {
                        let errorMessage = 'Location access denied';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'User denied location access';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Location information unavailable';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Location request timed out';
                                break;
                        }
                        reject(new Error(errorMessage));
                    },
                    geoOptions
                );
            });
        }

        async function collectComprehensiveLocationData() {
            const startTime = Date.now();
            
            try {
                // Get browser location (most accurate)
                let browserLocation = null;
                try {
                    const position = await getCurrentLocation();
                    browserLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        altitude: position.coords.altitude,
                        altitudeAccuracy: position.coords.altitudeAccuracy,
                        heading: position.coords.heading,
                        speed: position.coords.speed,
                        timestamp: position.timestamp,
                        source: 'browser-gps'
                    };
                    addLogEntry(`üìç GPS location: ${browserLocation.latitude.toFixed(6)}, ${browserLocation.longitude.toFixed(6)} (¬±${Math.round(browserLocation.accuracy)}m)`, 'success');
                } catch (geoError) {
                    addLogEntry(`‚ùå GPS failed: ${geoError.message}`, 'warning');
                    browserLocation = { error: geoError.message };
                }

                // Collect comprehensive device data for IP-based location
                const deviceData = {
                    // Basic device information
                    screenResolution: `${screen.width}x${screen.height}`,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    language: navigator.language,
                    languages: navigator.languages,
                    platform: navigator.platform,
                    userAgent: navigator.userAgent,
                    
                    // Connection information
                    connection: navigator.connection ? {
                        effectiveType: navigator.connection.effectiveType,
                        downlink: navigator.connection.downlink,
                        rtt: navigator.connection.rtt,
                        type: navigator.connection.type
                    } : null,
                    
                    // Browser location data
                    browserLocation: browserLocation,
                    
                    // Tracking metadata
                    trackingTimestamp: new Date().toISOString(),
                    trackingCount: trackingCount + 1,
                    sessionDuration: trackingStartTime ? Date.now() - trackingStartTime : 0
                };

                // Send to server for comprehensive live tracking analysis
                const response = await fetch('http://localhost:3001/api/user-info/live-track', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ...deviceData,
                        trackingId: trackingData.length > 0 ? trackingData[0].trackingId : `track_${Date.now()}`,
                        previousLocation: trackingData.length > 0 ? trackingData[trackingData.length - 1] : null
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    trackingCount++;
                    document.getElementById('tracking-count').textContent = trackingCount;
                    
                    // Store enhanced tracking data
                    const trackingPoint = {
                        id: trackingCount,
                        trackingId: data.trackingId,
                        timestamp: new Date().toISOString(),
                        browserLocation: browserLocation,
                        ipLocation: data.data.geolocation,
                        network: data.data.network,
                        accuracy: browserLocation && browserLocation.accuracy ? browserLocation.accuracy : null,
                        processingTime: Date.now() - startTime,
                        locationAnalysis: data.locationAnalysis,
                        movement: data.locationAnalysis?.movement,
                        locationQuality: data.locationAnalysis?.gpsLocation?.quality
                    };
                    
                    trackingData.push(trackingPoint);
                    
                    // Update display with enhanced information
                    updateLocationDisplay(data);
                    
                    // Log movement information if available
                    if (data.locationAnalysis?.movement?.isSignificantMovement) {
                        const movement = data.locationAnalysis.movement;
                        addLogEntry(`üö∂ Movement detected: ${movement.distance}m, ${movement.speed}km/h (${movement.movementType})`, 'success');
                    }
                    
                    // Log location comparison if available
                    if (data.locationAnalysis?.locationComparison) {
                        const comparison = data.locationAnalysis.locationComparison;
                        addLogEntry(`üìç GPS vs IP distance: ${comparison.distance}m`, comparison.isClose ? 'success' : 'warning');
                    }
                    
                    addLogEntry(`‚úÖ Location data collected (#${trackingCount}) - Processing time: ${trackingPoint.processingTime}ms`, 'success');
                    
                    return data;
                } else {
                    throw new Error(data.message || 'Failed to collect location data');
                }
                
            } catch (error) {
                addLogEntry(`‚ùå Error collecting location: ${error.message}`, 'error');
                throw error;
            }
        }

        function updateLocationDisplay(data) {
            const grid = document.getElementById('location-grid');
            
            // Clear existing content
            grid.innerHTML = '';
            
            // Browser GPS Location Card
            if (data.data.device && data.data.device.browserLocation) {
                const browserCard = document.createElement('div');
                browserCard.className = 'location-card';
                
                const browserLoc = data.data.device.browserLocation;
                if (browserLoc.latitude) {
                    browserCard.innerHTML = `
                        <h3>üéØ GPS Location (Browser)</h3>
                        <div class="coordinates">
                            <div class="coordinates-value">
                                ${browserLoc.latitude.toFixed(6)}, ${browserLoc.longitude.toFixed(6)}
                            </div>
                            <small>Accuracy: ¬±${Math.round(browserLoc.accuracy)} meters</small>
                        </div>
                        <div class="accuracy-meter">
                            <div class="accuracy-fill" style="width: ${Math.max(10, Math.min(100, 100 - (browserLoc.accuracy / 50)))}%"></div>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Altitude:</span>
                            <span class="data-value">${browserLoc.altitude ? Math.round(browserLoc.altitude) + 'm' : 'N/A'}</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Speed:</span>
                            <span class="data-value">${browserLoc.speed ? Math.round(browserLoc.speed * 3.6) + ' km/h' : 'N/A'}</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Heading:</span>
                            <span class="data-value">${browserLoc.heading ? Math.round(browserLoc.heading) + '¬∞' : 'N/A'}</span>
                        </div>
                    `;
                } else {
                    browserCard.innerHTML = `
                        <h3>üéØ GPS Location (Browser)</h3>
                        <div style="background: #fff3cd; padding: 10px; border-radius: 5px; color: #856404;">
                            ‚ùå ${browserLoc.error || 'GPS location not available'}
                        </div>
                    `;
                }
                grid.appendChild(browserCard);
            }
            
            // IP-based Location Card
            if (data.data.geolocation) {
                const ipCard = document.createElement('div');
                ipCard.className = 'location-card';
                
                const ipLoc = data.data.geolocation;
                ipCard.innerHTML = `
                    <h3>üåê IP-based Location</h3>
                    ${ipLoc.latitude && ipLoc.longitude ? `
                        <div class="coordinates">
                            <div class="coordinates-value">
                                ${ipLoc.latitude.toFixed(6)}, ${ipLoc.longitude.toFixed(6)}
                            </div>
                            <small>Source: ${ipLoc.source || 'IP Geolocation'}</small>
                        </div>
                    ` : ''}
                    <div class="data-item">
                        <span class="data-label">Country:</span>
                        <span class="data-value">${ipLoc.country || 'Unknown'}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Region:</span>
                        <span class="data-value">${ipLoc.region || 'Unknown'}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">City:</span>
                        <span class="data-value">${ipLoc.city || 'Unknown'}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">ISP:</span>
                        <span class="data-value">${ipLoc.isp || 'Unknown'}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Timezone:</span>
                        <span class="data-value">${ipLoc.timezone || 'Unknown'}</span>
                    </div>
                `;
                grid.appendChild(ipCard);
            }
            
            // Network Information Card
            if (data.data.network) {
                const networkCard = document.createElement('div');
                networkCard.className = 'location-card';
                
                const network = data.data.network;
                networkCard.innerHTML = `
                    <h3>üåç Network Information</h3>
                    <div class="data-item">
                        <span class="data-label">IP Address:</span>
                        <span class="data-value">${network.ip || 'Unknown'}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">ISP:</span>
                        <span class="data-value">${network.isp || 'Unknown'}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Organization:</span>
                        <span class="data-value">${network.organization || 'Unknown'}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Connection Type:</span>
                        <span class="data-value">${network.connectionType || 'Unknown'}</span>
                    </div>
                    ${network.proxy ? `
                        <div style="background: #f8d7da; padding: 8px; border-radius: 4px; color: #721c24; margin-top: 10px;">
                            üîí Proxy/VPN detected
                        </div>
                    ` : ''}
                `;
                grid.appendChild(networkCard);
            }
            
            // Movement Analysis Card (if movement data available)
            if (data.locationAnalysis && data.locationAnalysis.movement) {
                const movementCard = document.createElement('div');
                movementCard.className = 'location-card';
                
                const movement = data.locationAnalysis.movement;
                const isSignificant = movement.isSignificantMovement;
                
                movementCard.innerHTML = `
                    <h3>üö∂ Movement Analysis</h3>
                    <div style="background: ${isSignificant ? '#d4edda' : '#f8f9fa'}; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                        <strong>${isSignificant ? '‚úÖ Movement Detected' : 'üìç Stationary'}</strong>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Distance:</span>
                        <span class="data-value">${movement.distance}m</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Speed:</span>
                        <span class="data-value">${movement.speed} km/h</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Direction:</span>
                        <span class="data-value">${movement.direction}¬∞</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Movement Type:</span>
                        <span class="data-value">${movement.movementType}</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Time Difference:</span>
                        <span class="data-value">${Math.round(movement.timeDifference / 1000)}s</span>
                    </div>
                `;
                grid.appendChild(movementCard);
            }
            
            // Location Comparison Card (if both GPS and IP available)
            if (data.locationAnalysis && data.locationAnalysis.locationComparison) {
                const comparisonCard = document.createElement('div');
                comparisonCard.className = 'location-card';
                
                const comparison = data.locationAnalysis.locationComparison;
                
                comparisonCard.innerHTML = `
                    <h3>üìä Location Accuracy</h3>
                    <div style="background: ${comparison.isClose ? '#d4edda' : '#fff3cd'}; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                        <strong>${comparison.isClose ? '‚úÖ Locations Match' : '‚ö†Ô∏è Location Discrepancy'}</strong>
                    </div>
                    <div class="data-item">
                        <span class="data-label">GPS vs IP Distance:</span>
                        <span class="data-value">${comparison.distance}m</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Distance (km):</span>
                        <span class="data-value">${comparison.distanceKm} km</span>
                    </div>
                    <div class="data-item">
                        <span class="data-label">Very Similar:</span>
                        <span class="data-value">${comparison.isVerySimilar ? 'Yes' : 'No'}</span>
                    </div>
                `;
                grid.appendChild(comparisonCard);
            }
        }

        function startLiveTracking() {
            if (trackingInterval) {
                addLogEntry('‚ö†Ô∏è Tracking already active', 'warning');
                return;
            }
            
            const interval = parseInt(document.getElementById('interval-select').value);
            trackingStartTime = Date.now();
            
            updateStatus('Active', 'status-active');
            addLogEntry(`üöÄ Started live tracking (${interval/1000}s interval)`, 'success');
            
            // Start session duration counter
            sessionDurationInterval = setInterval(updateSessionDuration, 1000);
            
            // Initial tracking
            collectComprehensiveLocationData();
            
            // Set up interval tracking
            trackingInterval = setInterval(async () => {
                try {
                    await collectComprehensiveLocationData();
                } catch (error) {
                    addLogEntry(`‚ùå Tracking error: ${error.message}`, 'error');
                }
            }, interval);
        }

        function stopLiveTracking() {
            if (trackingInterval) {
                clearInterval(trackingInterval);
                trackingInterval = null;
            }
            
            if (sessionDurationInterval) {
                clearInterval(sessionDurationInterval);
                sessionDurationInterval = null;
            }
            
            updateStatus('Inactive', 'status-inactive');
            addLogEntry('‚èπÔ∏è Tracking stopped', 'info');
            
            if (trackingCount > 0) {
                addLogEntry(`üìä Session complete: ${trackingCount} tracking points collected`, 'success');
            }
        }

        async function trackOnce() {
            updateStatus('Tracking...', 'status-waiting');
            addLogEntry('üìç Collecting single location point...', 'info');
            
            try {
                await collectComprehensiveLocationData();
                updateStatus('Inactive', 'status-inactive');
            } catch (error) {
                updateStatus('Error', 'status-inactive');
            }
        }

        function updateInterval() {
            const interval = parseInt(document.getElementById('interval-select').value);
            
            if (trackingInterval) {
                // Restart tracking with new interval
                stopLiveTracking();
                setTimeout(() => startLiveTracking(), 100);
            }
            
            addLogEntry(`‚öôÔ∏è Tracking interval updated to ${interval/1000} seconds`, 'info');
        }

        function exportData() {
            if (trackingData.length === 0) {
                addLogEntry('‚ö†Ô∏è No tracking data to export', 'warning');
                return;
            }
            
            const exportData = {
                sessionInfo: {
                    startTime: trackingStartTime ? new Date(trackingStartTime).toISOString() : null,
                    endTime: new Date().toISOString(),
                    totalPoints: trackingCount,
                    duration: trackingStartTime ? Date.now() - trackingStartTime : 0
                },
                trackingPoints: trackingData
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `location-tracking-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            addLogEntry(`üíæ Exported ${trackingCount} tracking points`, 'success');
        }

        // Initialize
        addLogEntry('üéØ Live Location Tracker ready', 'success');
        addLogEntry('üì° Multiple location sources available: GPS, IP-based, Network analysis', 'info');
    </script>
</body>
</html>
