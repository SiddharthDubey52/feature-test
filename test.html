<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Info API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .ip-display {
            background-color: #e7f3ff;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        .ip-label {
            font-weight: bold;
            color: #007bff;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .ip-value {
            font-size: 24px;
            font-family: monospace;
            font-weight: bold;
            color: #333;
        }
        .summary-info {
            background-color: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .summary-label {
            font-weight: bold;
            color: #495057;
        }
        .summary-value {
            font-family: monospace;
            color: #007bff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Advanced User Tracker</h1>
        <p>This system collects the maximum possible information within browser security limits:</p>
        <ul style="text-align: left; color: #666; font-size: 14px; margin: 20px 0;">
            <li>‚úÖ Device fingerprinting & specifications</li>
            <li>‚úÖ Network information & location</li>
            <li>‚úÖ Browser capabilities & plugins</li>
            <li>‚úÖ User behavior patterns</li>
            <li>‚úÖ System information</li>
            <li>‚ùå Photos/Camera (requires permission popup)</li>
            <li>‚ùå Browser history (blocked by browsers)</li>
            <li>‚ùå Personal files (security restriction)</li>
        </ul>
        
        <button onclick="getUserInfo()">üöÄ Collect Maximum User Information</button>
        
        <div id="ip-section" style="display: none;">
            <div class="ip-display">
                <div class="ip-label">Your Network IP Address</div>
                <div class="ip-value" id="ip-value">-</div>
            </div>
        </div>
        
        <div id="summary-section" style="display: none;">
            <div class="summary-info">
                <h3>Summary Information</h3>
                <div id="summary-content"></div>
            </div>
        </div>
        
        <div id="result"></div>
    </div>

    <script>
        // Advanced fingerprinting functions
        
        // Canvas fingerprinting
        function getCanvasFingerprint() {
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('Canvas fingerprinting üé®', 2, 2);
                ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                ctx.fillRect(100, 5, 80, 20);
                return canvas.toDataURL();
            } catch (e) {
                return 'Canvas fingerprinting failed';
            }
        }

        // WebGL fingerprinting
        function getWebGLFingerprint() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) return 'WebGL not supported';
                
                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                return {
                    vendor: gl.getParameter(gl.VENDOR),
                    renderer: gl.getParameter(gl.RENDERER),
                    version: gl.getParameter(gl.VERSION),
                    shadingLanguageVersion: gl.getParameter(gl.SHADING_LANGUAGE_VERSION),
                    unmaskedVendor: debugInfo ? gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) : null,
                    unmaskedRenderer: debugInfo ? gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL) : null,
                    supportedExtensions: gl.getSupportedExtensions()
                };
            } catch (e) {
                return 'WebGL fingerprinting failed';
            }
        }

        // Audio fingerprinting
        async function getAudioFingerprint() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const analyser = audioContext.createAnalyser();
                oscillator.type = 'triangle';
                oscillator.frequency.setValueAtTime(10000, audioContext.currentTime);
                oscillator.connect(analyser);
                oscillator.start(0);
                
                return new Promise((resolve) => {
                    setTimeout(() => {
                        const dataArray = new Uint8Array(analyser.frequencyBinCount);
                        analyser.getByteFrequencyData(dataArray);
                        let fingerprint = 0;
                        for (let i = 0; i < dataArray.length; i++) {
                            fingerprint += dataArray[i];
                        }
                        oscillator.stop();
                        resolve(fingerprint.toString());
                    }, 100);
                });
            } catch (e) {
                return 'Audio fingerprinting failed';
            }
        }

        // Font detection
        function getFontsFingerprint() {
            const testFonts = [
                'Arial', 'Helvetica', 'Times New Roman', 'Courier New', 'Verdana',
                'Georgia', 'Palatino', 'Garamond', 'Bookman', 'Comic Sans MS',
                'Trebuchet MS', 'Arial Black', 'Impact', 'Lucida Sans Unicode',
                'Tahoma', 'Geneva', 'Lucida Console', 'Monaco', 'Brush Script MT'
            ];
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            const testString = 'mmmmmmmmmmlli';
            const testSize = '72px';
            
            context.font = testSize + ' monospace';
            const baseWidth = context.measureText(testString).width;
            
            const availableFonts = [];
            for (const font of testFonts) {
                context.font = testSize + ' ' + font + ', monospace';
                const width = context.measureText(testString).width;
                if (width !== baseWidth) {
                    availableFonts.push(font);
                }
            }
            
            return availableFonts;
        }

        // Check permissions without requesting them
        async function checkPermissionsStatus() {
            const permissions = {};
            const permissionsToCheck = [
                'geolocation', 'notifications', 'camera', 'microphone',
                'clipboard-read', 'clipboard-write', 'persistent-storage'
            ];
            
            for (const permission of permissionsToCheck) {
                try {
                    if (navigator.permissions) {
                        const result = await navigator.permissions.query({ name: permission });
                        permissions[permission] = result.state;
                    } else {
                        permissions[permission] = 'unknown';
                    }
                } catch (e) {
                    permissions[permission] = 'error';
                }
            }
            
            return permissions;
        }

        // Get media devices info without accessing them
        async function getMediaDevicesInfo() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                    return { supported: false };
                }
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                return {
                    supported: true,
                    audioInputs: devices.filter(d => d.kind === 'audioinput').length,
                    audioOutputs: devices.filter(d => d.kind === 'audiooutput').length,
                    videoInputs: devices.filter(d => d.kind === 'videoinput').length,
                    totalDevices: devices.length
                };
            } catch (e) {
                return { supported: false, error: e.message };
            }
        }

        // Battery information
        async function getBatteryInfo() {
            try {
                if ('getBattery' in navigator) {
                    const battery = await navigator.getBattery();
                    return {
                        level: battery.level,
                        charging: battery.charging,
                        chargingTime: battery.chargingTime,
                        dischargingTime: battery.dischargingTime,
                        supported: true
                    };
                }
                return { supported: false };
            } catch (e) {
                return { supported: false, error: e.message };
            }
        }

        // CSS features detection
        function detectCSSFeatures() {
            const features = {};
            const testElement = document.createElement('div');
            
            // Test various CSS features
            const cssTests = {
                flexbox: 'flex',
                grid: 'grid',
                transforms: 'transform',
                transitions: 'transition',
                animations: 'animation',
                gradients: 'background-image',
                borderRadius: 'border-radius',
                boxShadow: 'box-shadow',
                textShadow: 'text-shadow'
            };
            
            for (const [feature, property] of Object.entries(cssTests)) {
                features[feature] = property in testElement.style;
            }
            
            return features;
        }

        // Timezone information
        function getTimezoneInfo() {
            const date = new Date();
            return {
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                offset: date.getTimezoneOffset(),
                locale: Intl.DateTimeFormat().resolvedOptions().locale,
                calendar: Intl.DateTimeFormat().resolvedOptions().calendar,
                numberingSystem: Intl.DateTimeFormat().resolvedOptions().numberingSystem,
                currentTime: date.toISOString(),
                localTime: date.toString()
            };
        }

        // Helper function to get current position with better error handling
        function getCurrentPosition(options = {}) {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation is not supported by this browser'));
                    return;
                }

                const defaultOptions = {
                    enableHighAccuracy: true,
                    timeout: 10000, // 10 seconds
                    maximumAge: 300000 // 5 minutes
                };

                const finalOptions = { ...defaultOptions, ...options };

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve(position);
                    },
                    (error) => {
                        let errorMessage = 'Location access denied';
                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Location access denied by user';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Location information unavailable';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Location request timed out';
                                break;
                            default:
                                errorMessage = 'An unknown error occurred while retrieving location';
                                break;
                        }
                        reject(new Error(errorMessage));
                    },
                    finalOptions
                );
            });
        }

        async function getUserInfo() {
            const resultDiv = document.getElementById('result');
            const ipSection = document.getElementById('ip-section');
            const summarySection = document.getElementById('summary-section');
            const ipValue = document.getElementById('ip-value');
            const summaryContent = document.getElementById('summary-content');
            
            resultDiv.innerHTML = '<div class="loading">üîç Collecting maximum possible user information...</div>';
            ipSection.style.display = 'none';
            summarySection.style.display = 'none';
            
            try {
                // Start comprehensive data collection
                const startTime = performance.now();
                
                // Collect advanced device information
                const deviceInfo = {
                    // Basic device specs
                    screenResolution: `${screen.width}x${screen.height}`,
                    availWidth: screen.availWidth,
                    availHeight: screen.availHeight,
                    colorDepth: screen.colorDepth,
                    pixelDepth: screen.pixelDepth,
                    pixelRatio: window.devicePixelRatio,
                    
                    // System information
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    language: navigator.language,
                    languages: navigator.languages,
                    platform: navigator.platform,
                    userAgent: navigator.userAgent,
                    vendor: navigator.vendor,
                    product: navigator.product,
                    appName: navigator.appName,
                    appVersion: navigator.appVersion,
                    buildID: navigator.buildID,
                    
                    // Browser capabilities
                    cookieEnabled: navigator.cookieEnabled,
                    javaEnabled: navigator.javaEnabled ? navigator.javaEnabled() : false,
                    onlineStatus: navigator.onLine,
                    doNotTrack: navigator.doNotTrack,
                    
                    // Hardware information
                    hardwareConcurrency: navigator.hardwareConcurrency,
                    deviceMemory: navigator.deviceMemory,
                    maxTouchPoints: navigator.maxTouchPoints,
                    touchSupport: 'ontouchstart' in window || navigator.maxTouchPoints > 0,
                    
                    // Window information
                    windowSize: {
                        innerWidth: window.innerWidth,
                        innerHeight: window.innerHeight,
                        outerWidth: window.outerWidth,
                        outerHeight: window.outerHeight,
                        screenX: window.screenX,
                        screenY: window.screenY
                    },
                    
                    // Network connection (if available)
                    connection: navigator.connection ? {
                        effectiveType: navigator.connection.effectiveType,
                        downlink: navigator.connection.downlink,
                        rtt: navigator.connection.rtt,
                        saveData: navigator.connection.saveData,
                        type: navigator.connection.type
                    } : null,
                    
                    // Performance information
                    performance: {
                        timing: performance.timing ? {
                            navigationStart: performance.timing.navigationStart,
                            loadEventEnd: performance.timing.loadEventEnd,
                            domContentLoadedEventEnd: performance.timing.domContentLoadedEventEnd,
                            responseEnd: performance.timing.responseEnd,
                            domComplete: performance.timing.domComplete
                        } : null,
                        memory: performance.memory ? {
                            usedJSHeapSize: performance.memory.usedJSHeapSize,
                            totalJSHeapSize: performance.memory.totalJSHeapSize,
                            jsHeapSizeLimit: performance.memory.jsHeapSizeLimit
                        } : null,
                        navigation: performance.navigation ? {
                            type: performance.navigation.type,
                            redirectCount: performance.navigation.redirectCount
                        } : null
                    },
                    
                    // Browser plugins and features
                    plugins: Array.from(navigator.plugins || []).map(plugin => ({
                        name: plugin.name,
                        filename: plugin.filename,
                        description: plugin.description,
                        version: plugin.version
                    })),
                    
                    mimeTypes: Array.from(navigator.mimeTypes || []).map(mime => ({
                        type: mime.type,
                        description: mime.description,
                        suffixes: mime.suffixes
                    })),
                    
                    // Advanced fingerprinting
                    canvasFingerprint: getCanvasFingerprint(),
                    webglFingerprint: getWebGLFingerprint(),
                    audioFingerprint: await getAudioFingerprint(),
                    fontsFingerprint: getFontsFingerprint(),
                    
                    // Local storage capabilities
                    localStorage: typeof(Storage) !== "undefined",
                    sessionStorage: typeof(Storage) !== "undefined",
                    indexedDB: !!window.indexedDB,
                    webSQL: !!window.openDatabase,
                    
                    // Additional browser features
                    webRTC: !!(navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia),
                    webGL: !!window.WebGLRenderingContext,
                    webGL2: !!window.WebGL2RenderingContext,
                    webWorker: !!window.Worker,
                    sharedWorker: !!window.SharedWorker,
                    serviceWorker: !!navigator.serviceWorker,
                    
                    // Document and page information
                    documentInfo: {
                        title: document.title,
                        url: document.URL,
                        domain: document.domain,
                        referrer: document.referrer,
                        characterSet: document.characterSet,
                        contentType: document.contentType,
                        lastModified: document.lastModified,
                        readyState: document.readyState,
                        visibilityState: document.visibilityState,
                        hidden: document.hidden
                    },
                    
                    // Permissions status
                    permissions: await checkPermissionsStatus(),
                    
                    // Media devices info (without accessing them)
                    mediaDevices: await getMediaDevicesInfo(),
                    
                    // Battery information (if available)
                    battery: await getBatteryInfo(),
                    
                    // CSS and style information
                    cssFeatures: detectCSSFeatures(),
                    
                    // Timezone and locale information
                    timezoneInfo: getTimezoneInfo(),
                    
                    // Browser history length (only the count, not the history itself)
                    historyLength: history.length,
                    
                    // Collection timestamp
                    collectionTime: new Date().toISOString(),
                    processingTime: performance.now() - startTime
                };

                // Try to get precise location using browser geolocation API
                try {
                    resultDiv.innerHTML = '<div class="loading">üìç Requesting precise location access for enhanced accuracy...</div>';
                    
                    const position = await getCurrentPosition();
                    deviceInfo.browserLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        altitude: position.coords.altitude,
                        altitudeAccuracy: position.coords.altitudeAccuracy,
                        heading: position.coords.heading,
                        speed: position.coords.speed,
                        timestamp: position.timestamp,
                        source: 'browser-geolocation'
                    };
                    
                    console.log('‚úÖ Precise location obtained:', deviceInfo.browserLocation);
                } catch (geoError) {
                    console.log('‚ö†Ô∏è Browser geolocation failed:', geoError.message);
                    // Continue without precise location - will use IP-based location
                    deviceInfo.browserLocation = {
                        error: geoError.message,
                        source: 'browser-geolocation-failed'
                    };
                }

                // Make API call
                const response = await fetch('http://localhost:3001/api/user-info', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(deviceInfo)
                });

                const data = await response.json();
                
                if (data.success) {
                    // Display IP prominently
                    ipValue.textContent = data.data.network.ip || 'Not detected';
                    ipSection.style.display = 'block';
                    
                    // Show enhanced summary information with security notes
                    const summary = data.summary;
                    summaryContent.innerHTML = `
                        <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px; border-left: 4px solid #ffc107;">
                            <strong>‚ö†Ô∏è Browser Security Note:</strong><br>
                            ‚Ä¢ Photos/Camera: Requires explicit user permission (popup)<br>
                            ‚Ä¢ Browser History: Completely blocked by all modern browsers<br>
                            ‚Ä¢ Personal Files: Sandboxed - cannot access user's files<br>
                            ‚Ä¢ Screenshots: Not possible without user consent<br>
                            <strong>‚úÖ Maximum data collected within security limits!</strong>
                        </div>
                        
                        <div class="summary-item">
                            <span class="summary-label">IP Address:</span>
                            <span class="summary-value">${summary.ip || 'Unknown'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Country:</span>
                            <span class="summary-value">${summary.country || 'Unknown'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">City:</span>
                            <span class="summary-value">${summary.city || 'Unknown'}</span>
                        </div>
                        ${data.data.device.browserLocation && data.data.device.browserLocation.latitude ? `
                        <div class="summary-item" style="background: #e8f5e8; margin: 5px 0; padding: 8px; border-radius: 4px;">
                            <span class="summary-label">üéØ Precise Location:</span>
                            <span class="summary-value" style="color: #28a745; font-weight: bold;">
                                ${data.data.device.browserLocation.latitude.toFixed(6)}, ${data.data.device.browserLocation.longitude.toFixed(6)}
                            </span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">üìç GPS Accuracy:</span>
                            <span class="summary-value" style="color: #28a745;">${Math.round(data.data.device.browserLocation.accuracy)} meters</span>
                        </div>
                        ` : data.data.device.browserLocation && data.data.device.browserLocation.error ? `
                        <div class="summary-item" style="background: #fff3cd; margin: 5px 0; padding: 8px; border-radius: 4px;">
                            <span class="summary-label">üìç GPS Location:</span>
                            <span class="summary-value" style="color: #856404;">‚ùå ${data.data.device.browserLocation.error}</span>
                        </div>
                        ` : ''}
                        <div class="summary-item">
                            <span class="summary-label">üîç Device Fingerprint:</span>
                            <span class="summary-value" style="font-family: monospace; font-size: 0.8em;">
                                ${data.data.fingerprint ? data.data.fingerprint.hash.substring(0, 16) + '...' : 'Generated'}
                            </span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">üîí Security Threat:</span>
                            <span class="summary-value" style="color: ${data.data.security && data.data.security.threatLevel ? 
                                (data.data.security.threatLevel.level === 'High' ? '#dc3545' : 
                                 data.data.security.threatLevel.level === 'Medium' ? '#ffc107' : '#28a745') : '#28a745'}">
                                ${data.data.security && data.data.security.threatLevel ? 
                                    data.data.security.threatLevel.level : 'Low'}
                            </span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Browser:</span>
                            <span class="summary-value">${summary.browser || 'Unknown'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">OS:</span>
                            <span class="summary-value">${summary.os || 'Unknown'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Device:</span>
                            <span class="summary-value">${summary.device || 'Unknown'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Screen Resolution:</span>
                            <span class="summary-value">${data.data.device.screenResolution || 'Unknown'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Timezone:</span>
                            <span class="summary-value">${data.data.device.timezone || 'Unknown'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">üìä Data Points Collected:</span>
                            <span class="summary-value" style="color: #28a745; font-weight: bold;">
                                ${Object.keys(data.data).length * 10}+ data points
                            </span>
                        </div>
                    `;
                    summarySection.style.display = 'block';
                    
                    // Show full JSON response
                    resultDiv.innerHTML = `<details>
                        <summary><strong>Full API Response (Click to expand)</strong></summary>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </details>`;
                } else {
                    resultDiv.innerHTML = `<div style="color: red;">Error: ${data.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>
